<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>PPI Home Security</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
    .entry { padding:10px; margin:6px 0; border-radius:6px; }
    .rfid-auth { background:#1f7a1f; }
    .rfid-deny { background:#7a1f1f; }
    .motion { background:#1f3b7a; }
    .time { color:#aaa; margin-right:10px; }
    img.thumb { display:block; margin-top:8px; max-width:260px; border-radius:6px; }
    a { color:#cfc; }
    .small { font-size: 12px; color: #ddd; margin-top: 4px; }
  </style>
</head>
<body>
  <h1>Live Log</h1>

  <div id="log">
    {% for e in entries|reverse %}
      {% if e.get("type") in ["MOTION", "MOTION_PHOTO"] %}
        <div class="entry motion">
          <span class="time">{{ e.timestamp }}</span> MOTION detected
          {% if e.get("photo") %}
            <div class="small"><a href="/static/{{ e.photo }}" target="_blank">Open photo</a></div>
            <img class="thumb" src="/static/{{ e.photo }}" alt="motion photo">
          {% else %}
            <div class="small">photo pending...</div>
          {% endif %}
        </div>
      {% else %}
        <div class="entry {{ 'rfid-auth' if e.status == 'AUTH' else 'rfid-deny' }}">
          <span class="time">{{ e.timestamp }}</span>
          RFID - {{ e.name }} ({{ e.uid }}) status {{ e.status }}
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <script>
    const log = document.getElementById("log");

    // Map: timestamp -> div, damit wir "photo pending" updaten kï¿½nnen
    const motionByTimestamp = new Map();

    function renderMotion(div, e) {
      let html = '<span class="time">' + e.timestamp + '</span> MOTION detected';
      if (e.photo) {
        html += '<div class="small"><a href="/static/' + e.photo + '" target="_blank">Open photo</a></div>';
        html += '<img class="thumb" src="/static/' + e.photo + '" alt="motion photo">';
      } else {
        html += '<div class="small">photo pending...</div>';
      }
      div.innerHTML = html;
    }

    const source = new EventSource("/events");
    source.onmessage = function(event) {
      const e = JSON.parse(event.data);

      if (e.type === "MOTION") {
        const div = document.createElement("div");
        div.classList.add("entry", "motion");
        renderMotion(div, e);
        log.prepend(div);

        motionByTimestamp.set(e.timestamp, div);
        return;
      }

      if (e.type === "MOTION_PHOTO") {
        const existing = motionByTimestamp.get(e.timestamp);
        if (existing) {
          renderMotion(existing, e);
        } else {
          // falls page spï¿½ter verbunden wurde, einfach neu einfï¿½gen
          const div = document.createElement("div");
          div.classList.add("entry", "motion");
          renderMotion(div, e);
          log.prepend(div);
          motionByTimestamp.set(e.timestamp, div);
        }
        return;
      }

      // RFID
      const div = document.createElement("div");
      div.classList.add("entry", e.status === "AUTH" ? "rfid-auth" : "rfid-deny");
      div.innerHTML =
        '<span class="time">' + e.timestamp + '</span> ' +
        'RFID - ' + e.name + ' (' + e.uid + ') status ' + e.status;
      log.prepend(div);
    };
  </script>

</body>
</html>
